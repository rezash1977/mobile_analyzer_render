# =========================================================================
# Render Blueprint (Infrastructure as Code) for Mobile Price Analyzer
# VERSION 3 - Clean file to resolve parsing issues
# =========================================================================

services:
  # -----------------------------------------------------------------------
  # زیرساخت: دیتابیس و صف پیام
  # -----------------------------------------------------------------------

  - type: postgres
    name: mobile-db
    plan: free

  - type: redis
    name: message-queue
    plan: free

  # -----------------------------------------------------------------------
  # سرویس‌های برنامه: API Gateway, Extractor, Parser
  # -----------------------------------------------------------------------

  - type: web
    name: api-gateway
    env: docker
    region: frankfurt
    plan: free
    repo: https://github.com/rezash1977/mobile_analyzer_render.git

    dockerContext: ./api_gateway
    dockerfilePath: ./api_gateway/Dockerfile

    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: mobile-db
          property: connectionString
      - key: PYTHONUNBUFFERED
        value: 1

    startCommand: "gunicorn api_gateway.main:app"

  - type: worker
    name: extractor-worker
    env: docker
    region: frankfurt
    plan: free
    repo: https://github.com/rezash1977/mobile_analyzer_render.git

    dockerContext: ./extractor
    dockerfilePath: ./extractor/Dockerfile

    envVars:
      - key: REDIS_URL
        fromService:
          type: redis
          name: message-queue
          property: connectionString
      - fromGroup: telegram-secrets
      - key: PYTHONUNBUFFERED
        value: 1

    startCommand: "python main.py"

  - type: worker
    name: parser-worker
    env: docker
    region: frankfurt
    plan: free
    repo: https://github.com/rezash1977/mobile_analyzer_render.git

    dockerContext: ./parser
    dockerfilePath: ./parser/Dockerfile

    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: mobile-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: redis
          name: message-queue
          property: connectionString
      - key: PYTHONUNBUFFERED
        value: 1

    startCommand: "python main.py"

# =========================================================================
# گروه متغیرهای محرمانه
# =========================================================================

envVarGroups:
  - name: telegram-secrets
    envVars:
      - key: TELEGRAM_API_ID
        value: "" # این مقدار را از داشبورد Render وارد کنید
      - key: TELEGRAM_API_HASH
        value: "" # این مقدار را از داشبورد Render وارد کنید
      - key: TELEGRAM_TARGET_CHAT_ID
        value: "" # این مقدار را از داشبورد Render وارد کنید